# 权限管理
## 基于角色的权限管理
所谓权限管理，简单的来说就是判定某条消息是否被正确的授权，此处的消息泛指EOS中一切调用，包括交易和对智能合约的调用。在区块链中，比较常见的一种权限管理方式是判定一笔交易是否包含有效的签名，比特币中每笔交易都会做类似的判定，这种权限管理方式属于很简单的一种类型，它的审查范围是针对每笔交易，没有细化到账号级别，并且在这类判定中，操作所需权限（签名）都是已知的，而在实际情况中，权限一般都会绑定到账号或者多人账号级别，并且账号所拥有的权限和操作所需要的权限是分别控制的，EOS 提供的这种声明式的权限系统可以在账户级别提供细粒度和高纬度的控制，它可以有效的管理什么账号可以在什么时间做什么事情。  

认证和权限管理必须标准化，并且与应用程序的业务逻辑分开，这样可以通过开发工具以通用的方式来管理权限，并且为性能优化提供可能。

每个账号都能被其他多个账号和私钥按照权重组合进行控制，这就创造了一种分层级的权限结构，它真实反映了现实中的权限分配方式，并且让多用户共同管理资产变得从未如此简单。这种多账户控制机制，能对账户的安全性提供保障，减少被黑客攻击而造成的资金损失风险。EOS甚至还允许定义某种多账户和私钥的组合可以发送特定的消息类型给另外一个账号。举个例子，可以指定一个密钥给一个用户的社交媒体账号，同时另一个密钥访问交易所。甚至可以授权其他账号来代表本账号而无需把自己的密钥分配给他们。

## 命名的权限级别
EOS 中每个账号都会有两个固有的命名权限，如下：

- `owner`   
`owner` 表示账户的所有权（是账户最高权限），此权限能够对账号做所有的操作，甚至可以重新恢复那些已经被泄漏的权限，一般只有很少的操作需要此权限。通常情况下，建议你把此权限对应的私钥进行冷存储，不要把它与任何人分享。
- `active`  
`active`权限可以用来进行转币，投票和其他的一些高级别的操作。

除了系统固有的这两种命名权限外，账号还可以添加定制的命名权限来扩充账号管理功能，并且这种权限可以从更高级别的命名权限继承。每一个命名权限都支持多重签名阀值校验，其中的多重签名可以包含密钥和/或其他账户的命名权限级别。   

针对上面所说的权限级别，这里举一个例子。在Steem区块链应用中，包含了三个硬编码的命名权限级别，分别是`owner`, `active`和`posting`, `posting` 权限只能进行如投票和发帖的社交活动，`active`权限可以做除了变更拥有之外的所有操作。`owner`权限则可以做包括冷存储在内的所有的事情。

## 命名的消息处理群组
EOS允许账号可以根据命名的嵌套群组来定义其消息处理函数。这个命名的消息处理群组可以在其他账号配置他们权限级别时被引用。

最高级别的消息处理群组是账户名称，最低级别的是一个账户所接收到的单独的消息类型，这个群组可以被这样引用：
`@accountname.groupa.subgroupb.MessageType`

在这样的模型下，交易所合约可以通过将挂单的创建和取消分组，从而与充值提现分离开。交易所合约的这种分组对用户而言带来了方便。

## 签名
### 单签（默认账户配置）
账号在创建的时候，默认会有两个权限，分别是`owner` 和`active`，每个权限对应一套密钥（一个公钥，一个私钥），每套密钥对应的权重都是1，权限的验证阀值也是1，因此消息的授权只需要某一个权限的单独签名即可，如下：

| Permission | Account | Weight | Threshold |
|:--|:--|:--|:--|
| owner |  |  | 1 |
|  | EOS5EzTZZQQxdrDaJAPD9pDzGJZ5bj34HaAb8yuvjFHGWzqV25Dch | 1 |  |
| active |  |  | 1 |
|  | EOS61chK8GbH4ukWcbom8HgK95AeUfP8MBPn7XRq8FeMBYYTgwmcX | 1 |  |

在以上@bob账号中，bob的`owner`的权限权重是1，交易签名所需要的授权阀值也是1，因此当bob需要发送交易消息的时候，只需要使用owner的key对交易消息进行签名即可通过验证。

### 多签与定制权限
以下我们虚构一个需要多签名的账户@multisig. 在这个场景中，@multisig 账号的`owner`和`active`权限分别有需要两个账户的授权，`publish`权限则需要三个签名，包括两个账户和一个`key`，并且这三个签名的权重是不一样的，具体如下：

| Permission | Account | Weight | Threshold |
|:--|:--|:--|:--|
| owner |  |  | 2 |
|  | @bob | 1 |  |
|  | @stacy | 1 |  |
| active |  |  | 1 |
|  | @bob | 1 |  |
|  | @stacy | 1 |  |
| publish |  |  | 2 |
|  | @bob | 2 |  |
|  | @stacy | 2 |  |
|  | EOS7Hnv4iBWo1pcEpP8JyFYCJLRUzYcXSqtQBcEnysYDFTEbUpi6y | 1 |  |

在以上场景中，由于`owner`的权限阀值是2，而`owner`权限下的两个账号的权重都是1，因此，当需要对交易消息进行签名的时候，需要这两个账号同时授权才可以。  

如果所发送的交易消息需要`active`权限，由于此权限的阀值是1，这就意味着只需要`active`权限下任何一个账号授权就可以了。  

这里还有一个自定义的命名权限叫做`publish`, 此权限的阀值是2，而其下的账号@bob和@stacy的权重都是2，另外一个key的权重是1，这就意味着@bob和@stacy都可以独立的进行签名，而key则需要另外一个签名一起才可以进行授权。  

在以上案例中，权限的设置同时使用了**账号**和**key** 的形式，这种形式初看起来觉得意义不大，但其实引入了一种非常灵活的维度。

## 权限映射
命名权限级别和消息处理群组这两个概念之间可以做映射，也就是说，可以将某个消息处理群组分配到某个权限级别上。举个例子：一个账户所有者可以将自己社交媒体应用与自己的“朋友”权限群组建立映射，有了这个映射，任何朋友都可以以这一账户的身份在社交媒体上发帖，但尽管他们能够以账户所有者的身份发帖，他们仍然使用自己的密钥来签名消息，这意味着总可以辨别出是哪一个朋友在以何种方式使用账户。

## 评估权限
当@alice发送一条类型为“Action”的消息给@bob 时，EOS首先会检查是否存在一条@alice权限和@bob.groupa.subgroup.Action操作之间的映射，如果没有找到，会继续检查@bob.groupa.subgroup与@alice权限之间是否存在映射，然后是@bob.groupa,最后@bob将被检查，如果都没有找到，那么就假定映射为命名权限@alice.active。  
一旦某个映射被识别，则通过阀值多签名流程验证权限是否有效，如果失败了，则会找寻其父权限，直至拥有者权限@alice.owner.

![evaluating permission](images/3.1.eval-perm.png?raw=true)

请看以上事例，图中@USER是一个账户，@EXCHANGE.CONTRACT是个交易所智能合约。@USER账号对应着一组权限，分别是`OWNER`, `ACTIVE`, `FAMILY`, `FRIENDS`,`LAWYER`，其中`OWNER`,`ACTIVE`为EOS提供的账号固有权限，其他则为自定义的权限。他们之间有继承关系，`FRIENDS`权限是继承自`FAMILY`的。  

@EXCHANGE.CONTRACT 智能合约中定义了一些消息类型，其中`WITHDRAW MESSAGE`和`TRADE GROUP`是平行的消息类型，`BUY`,`SELL`,`CANCEL`消息都是挂在`TRADE GRAOUP`下的。  

图中@User 把交易所智能合约的消息类型和账户的权限做了映射，`CONTRACT`及其下的`TRADE` 类型的消息映射到`FAMILY`权限下，此处相当于在`FAMILY`权限下有两个映射。`WITHDRAW`类型的消息映射到`LAWYER`权限下面，这样的映射形成了如下规则：

1. `FRIENDS`权限下能够做的做的事情，`FAMILY`权限都可以做，因为它是`FRIENDS`的父权限
2. `FAMILY`权限可以发送除`WITHDRAW`消息外其他任何消息，这是因为`WITHDRAW`消息在其他权限下做了特殊的映射，`FAMILY`权限无法覆盖此消息
3. `LAWYER`权限可以发送`WITHDRAW`消息，但无法发送其他消息

当用户向智能合约发送`BUY`消息的时候，系统会按照如下规则判断权限是否符合：

1. 判断是否有 @exchange.contract.buy 和账号权限映射，如果有，直接返回对应的权限，如果没有，则继续
2. 判断是否有 @exchange.contract 和账号权限映射，如果有，直接返回对应的权限，如果没有，则直接返回 @active 权限
3. 判断消息所附带的授权是否能够满足消息所需要的权限

## 并行权限评估
由于权限评估的过程是只读的，并且交易执行对权限的变更在一个区块结束之前是不会起作用的，这就意味着：

1. 所有的权限评估都是可以并行执行的
2. 无需再启动一个可能会引起回滚的高成本的应用逻辑去实现快速的权限验证，并行权限验证已经是一种快速解决方案了
3. 当收到需要等待的交易（pending transactions)时，系统可以直接对其进行权限评估，而无需等到此交易在执行时再被评估，这样可以节约交易执行时间

并且，由于权限验证的操作占据了验证类交易计算量的很大比例，因此，权限评估过程的只读和并发执行的特性将会使整体性能有一个质的飞跃。

## links
  * [目录](<preface.md>)
  * 上一节: [EOS 账号](<03.0.md>)
  * 下一节: [消息和处理程序](<03.2.md>)








